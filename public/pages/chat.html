<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <link rel="stylesheet" href="../styles/chat.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.map"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script>
  </head>
  <body>
    <div class="scrollBar">
      <ul id="messages-container"></ul>
    </div>

    <form id="form-message" action="">
      <input id="message-input" autocomplete="off" />
      <button id="btn-send" type="submit">Send</button>
    </form>

    <script>
      var socket = io();

      var form = document.getElementById('form-message')
      var input = document.getElementById('message-input')
      var messagesContainer = document.getElementById('messages-container')
      var userName = localStorage.getItem('username')
      var scroll = document.querySelector('.scrollBar')

      if (!userName){
        window.location.href = '/'
      }

      form.addEventListener('submit', (e) =>{
        e.preventDefault();
        if (input.value) {

          data = {
            username: userName,
            message: input.value
          }

          socket.emit('chatMessage', data)
          input.value = '';
        }
      })

      socket.on('chatMessage', (message) => {
        var li = document.createElement('li')
        li.classList.add('message')
        li.innerHTML = `<span class="message-username">${message.username}: </span> <span class="message-content">${message.message}</span>`
        messagesContainer.appendChild(li)

        scroll.scrollTop = scroll.scrollHeight
      })

      socket.on('userConnected', (messages) =>{
        messagesContainer.innerHTML = ''
        messages.forEach(message => {
          var li = document.createElement('li')
          li.classList.add('message')
          li.innerHTML = `<span class="message-username">${message.username}: </span> <span class="message-content">${message.message}</span>`
          messagesContainer.appendChild(li)
        })

        scroll.scrollTop = scroll.scrollHeight
      })

    </script>
  </body>
</html>